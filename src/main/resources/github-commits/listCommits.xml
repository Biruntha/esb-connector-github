<?xml version="1.0" encoding="UTF-8"?>
<template name="listCommits" xmlns="http://ws.apache.org/ns/synapse">
  <parameter name="owner"/>
  <parameter name="repo"/>
  <parameter name="sha"/>
  <parameter name="path"/>
  <parameter name="author"/>
  <parameter name="since"/>
  <parameter name="until"/>
  <sequence>
    <property expression="$func:owner" name="uri.var.owner"
      scope="default" type="STRING"/>
    <property expression="$func:repo" name="uri.var.repo"
      scope="default" type="STRING"/>
    <property expression="$func:sha" name="uri.var.sha" scope="default" type="STRING"/>
    <property expression="$func:path" name="uri.var.path"
      scope="default" type="STRING"/>
    <property expression="$func:author" name="uri.var.author"
      scope="default" type="STRING"/>
    <property expression="$func:since" name="uri.var.since"
      scope="default" type="STRING"/>
    <property expression="$func:until" name="uri.var.until"
      scope="default" type="STRING"/>
    <property name="uri.var.urlQuery" scope="default" type="STRING" value=""/>
    <script language="js"><![CDATA[var sha = mc.getProperty("uri.var.sha");
                var path = mc.getProperty("uri.var.path"); 
                var author = mc.getProperty("uri.var.author");
                var since = mc.getProperty("uri.var.since"); 
                var until = mc.getProperty("uri.var.until"); 
                var urlQuery = "";
                               
                  // constructing the optional url parameters 
                  // SHA or branch to start listing commits from. Default: the repositoryâ€™s default branch (usually master).                                                                                                                                                    
                  if (sha!=null && sha!= ""){
                     urlQuery+='sha='+ sha +'&';
                  }
                  
                  //Only commits containing this file path will be returned.
                  if (path!=null && path!= ""){
                     urlQuery+='path=' + path + '&';
                  }
                  
                  //GitHub login or email address by which to filter by commit author
                  if (author!=null && author!= ""){
                     urlQuery+='author='+ author +'&';
                  }
                  
                  //Only commits after this date will be returned. This is a timestamp in ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ.
                  if (since!=null && since!= ""){
                     urlQuery+='since='+ since +'&';
                  }
                  
                  //Only commits before this date will be returned. This is a timestamp in ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ.
                  if (until!=null && until!= ""){
                     urlQuery+='until='+ until +'&';
                  }
                  if(urlQuery!=""){
                     urlQuery = '?' + urlQuery.substring(0,urlQuery.length-1);
                  }

                  mc.setProperty('uri.var.urlQuery', urlQuery);]]></script>
    <call>
      <endpoint>
        <http method="get" trace="disable" uri-template="{+uri.var.apiUrl}/repos/{+uri.var.owner}/{+uri.var.repo}/commits{+uri.var.urlQuery}"/>
      </endpoint>
    </call>
  </sequence>
</template>
